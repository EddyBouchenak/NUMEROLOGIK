<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NUMEROLOGIK - Chemin de Vie & Compatibilit√©</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500&display=swap"
        rel="stylesheet">
    <style>
        /* BASE & TYPOGRAPHIE */
        :root {
            --color-bg: #111111;
            --color-primary: #f0e68c;
            /* Or Clair */
            --color-secondary: #a8dadc;
            --color-text: #e0e0e0;
            --color-subtext: #aaaaaa;
            --color-border: #444444;
        }

        body {
            margin: 0;
            background: var(--color-bg);
            color: var(--color-text);
            font-family: 'Montserrat', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            user-select: none;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0 5px;
            /* R√©duit car le logo est au dessus */
            letter-spacing: 2px;
        }

        .main-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 40px;
            /* Plus d'espace au dessus */
            margin-bottom: 20px;
            /* R√©duit en dessous */
        }

        .logo-wrapper {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 25px rgba(240, 230, 140, 0.3);
            /* Ombre un peu plus forte */
            margin-bottom: 0;
            /* Plus de marge interne car pas de texte */
            overflow: hidden;
            /* Masque ce qui d√©passe */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            /* Fond sombre par s√©curit√© */
        }

        .main-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Zoom plus fort pour bien remplir le cercle */
            transform: scale(1.35);
        }

        h2 {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 400;
            color: var(--color-primary);
            margin-top: 30px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* LAYOUT & CONTAINERS */
        .container {
            padding: 0 20px;
            max-width: 600px;
            margin: 0 auto;
            flex-grow: 1;
        }

        /* INPUTS & BOUTONS */
        .date-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"],
        input[type="number"],
        .input-single {
            flex-grow: 1;
            padding: 12px;
            background: #1e1e24;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            transition: all 0.3s;
            text-align: center;
        }

        input:focus,
        .input-single:focus-within {
            border-color: var(--color-primary);
            box-shadow: 0 0 8px rgba(240, 230, 140, 0.2);
        }

        .input-single {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
        }

        .input-single input {
            background: none;
            border: none;
            padding: 0;
            width: 100%;
            text-align: center;
        }

        .toggle-view {
            text-align: center;
            margin-bottom: 25px;
            font-size: 14px;
            color: var(--color-subtext);
            cursor: pointer;
            transition: color 0.3s;
        }

        .toggle-view:hover {
            color: var(--color-primary);
        }

        .btn-reveal {
            width: 100%;
            padding: 15px;
            background: var(--color-primary);
            color: var(--color-bg);
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(240, 230, 140, 0.2);
        }

        .btn-reveal:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(240, 230, 140, 0.4);
        }

        .error-message {
            color: #ff6347;
            /* Rouge Tomate */
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        /* OVERLAY & RESULTS */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: auto;
            background: radial-gradient(circle at center, #232526 0%, #111111 100%);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            padding: 20px 16px calc(20px + env(safe-area-inset-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .spinner-wrap {
            position: absolute;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
            opacity: 0;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .card-body {
            text-align: center;
            padding: 30px 20px;
            width: 100%;
            max-width: 450px;
            display: none;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.8s ease-out;
            background: #202020;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .card-body.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .card-icon {
            font-size: 60px;
            margin-bottom: 5px;
            color: var(--color-primary);
            line-height: 1;
            filter: drop-shadow(0 0 10px rgba(240, 230, 140, 0.3));
        }

        .animal-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(240, 230, 140, 0.4));
            display: inline-block;
        }

        .display-date {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-subtext);
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        /* Titre CV principal */
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--color-subtext);
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .card-description {
            font-size: 15px;
            line-height: 1.6;
            color: var(--color-text);
            margin-bottom: 25px;
        }

        /* STYLE NOUVELLE GRILLE DE SYMBOLIQUES (TUILLES) */
        .symbolics-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* 2 colonnes par d√©faut */
            gap: 10px;
            margin: 20px 0;
            padding: 0 5px;
        }

        .symbolic-tile {
            background: #282828;
            padding: 12px 5px;
            border-radius: 6px;
            border: 1px solid #333;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .symbolic-tile.full-width {
            grid-column: 1 / -1;
            /* Prend toute la largeur */
        }

        .tile-label {
            font-size: 10px;
            color: var(--color-subtext);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .tile-value {
            font-size: 14px;
            color: var(--color-text);
            font-weight: 700;
        }

        .symbolic-tile.archetype {
            background: #2f2f2f;
            border-color: var(--color-secondary);
            color: var(--color-secondary);
        }

        .symbolic-tile.archetype .tile-value {
            color: var(--color-secondary);
        }

        @media (max-width: 350px) {
            .symbolics-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-height: 700px) {
            .card-body {
                padding: 20px 16px;
            }

            .card-description {
                font-size: 14px;
            }
        }

        /* FIN STYLE NOUVELLE GRILLE */

        .oracle-message {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: 16px;
            color: var(--color-primary);
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
        }

        /* Bouton Comparer */
        .btn-compare {
            background: none;
            border: 1px solid var(--color-secondary);
            color: var(--color-secondary);
            margin-top: 20px;
        }

        .btn-compare:active {
            background: var(--color-secondary);
            color: var(--color-bg);
            border-color: var(--color-secondary);
        }

        .action-btn {
            margin-top: 15px;
            padding: 10px 30px;
            background: none;
            border: 1px solid var(--color-subtext);
            border-radius: 30px;
            color: var(--color-subtext);
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .action-btn:active {
            background: var(--color-primary);
            color: var(--color-bg);
            border-color: var(--color-primary);
        }

        /* COMPATIBILITY SECTION */
        #compatibility-section {
            padding: 20px;
            background: #202020;
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid var(--color-border);
            transition: all 0.5s ease-out;
        }

        .compatibility-result {
            margin-top: 20px;
            padding: 15px;
            background: #282828;
            border-radius: 8px;
            text-align: center;
        }

        .comp-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-secondary);
            margin-bottom: 5px;
        }

        .comp-desc {
            font-size: 14px;
            color: var(--color-subtext);
            line-height: 1.5;
        }

        /* D√©tails Comp Card (pour la deuxi√®me date) */
        .details-comp-card {
            background: #1a1a1a;
            padding: 15px 15px 5px 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }

        /* NOUVEAU STYLE POUR L'ENT√äTE DANS LA CARTE DE COMPARAISON */
        .comp-card-header h3 {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
            margin: 0;
            letter-spacing: 0.5px;
        }

        .comp-card-header .display-date {
            font-size: 13px;
            margin-bottom: 10px;
        }

        /* FIN NOUVEAU STYLE */

        .comp-label {
            color: var(--color-subtext);
            font-weight: 500;
            font-size: 12px;
            display: block;
            margin-top: 10px;
            border-top: 1px solid #333;
            padding-top: 5px;
        }

        .comp-value {
            color: var(--color-text);
            font-weight: 700;
            font-size: 15px;
            display: block;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        /* FOOTER */
        .footer {
            margin-top: 40px;
            padding: 20px 0;
            text-align: center;
            font-size: 11px;
            color: #444;
            cursor: pointer;
            /* Indique que c'est cliquable */
        }

        /* UTILS */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="container">
            <header class="main-header">
                <div class="logo-wrapper">
                    <img src="assets/logo_final.jpg" alt="NUMEROLOGIK" class="main-logo">
                </div>
            </header>

            <section id="main-form">
                <h2>Votre Chemin de Vie</h2>
                <div class="toggle-view" onclick="toggleInputMode()">
                    <span id="toggle-text">Passer √† la saisie compl√®te (JJ/MM/AAAA)</span>
                </div>

                <div id="input-mode-separate" class="date-input-group">
                    <input type="number" id="input-day" placeholder="Jour" min="1" max="31">
                    <input type="number" id="input-month" placeholder="Mois" min="1" max="12">
                    <input type="number" id="input-year" placeholder="Ann√©e" min="1900" max="2099">
                </div>

                <div id="input-mode-single" class="input-single hidden">
                    <input type="text" id="input-single" placeholder="JJ/MM/AAAA ou AAAA-MM-JJ" autocomplete="off">
                </div>

                <button class="btn-reveal" onclick="calculateLifePath()">R√©v√©ler mon Totem</button>
                <div class="error-message" id="error-msg"></div>

            </section>

            <section id="compatibility-toggle" class="toggle-view" onclick="toggleCompatibility()">
                <span>+ Ajouter une Compatibilit√© Num√©rologik</span>
            </section>

            <div id="compatibility-section" class="hidden">
                <h2>Compatibilit√©</h2>
                <div id="comp-input-mode-separate" class="date-input-group">
                    <input type="number" id="comp-input-day" placeholder="Jour 2" min="1" max="31">
                    <input type="number" id="comp-input-month" placeholder="Mois 2" min="1" max="12">
                    <input type="number" id="comp-input-year" placeholder="Ann√©e 2" min="1900" max="2099">
                </div>
                <button class="btn-reveal" onclick="calculateCompatibility()">Calculer la Relation</button>
                <div class="error-message" id="comp-error-msg"></div>

                <div id="compatibility-result" class="compatibility-result hidden">
                </div>
            </div>

        </div>

        <div id="overlay">
            <div class="spinner-wrap" id="loading-state">
                <div class="spinner"></div>
            </div>
            <div class="card-body" id="card-content">
                <div class="card-icon" id="display-icon"></div>
                <div class="display-date" id="display-date"></div>
                <div class="card-title" id="display-title"></div>
                <div class="card-description" id="display-desc"></div>

                <div class="symbolics-container" id="display-symbolics"></div>
                <div class="oracle-message" id="display-oracle"></div>

                <div class="action-btn btn-compare" onclick="showCompatibilitySection()">
                    Comparer une autre Date
                </div>

                <div class="action-btn" id="btn-back" onclick="onBackToHome()">Retour</div>
            </div>
        </div>

        <footer class="footer" onclick="toggleNet()">
            <p id="footer-text">&copy; 2025 NUMEROLOGIK. Calculs bas√©s sur la num√©rologie classique et les nombres
                ma√Ætres.
            </p>
        </footer>

        <script>
            // --- CONFIGURATION ---
            const ANALYTICS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzDojKACEkPrHfoWX9VwisjPZYnt3dD1pjd5oFqfSRTgN48QMJoP5OgsA0f3D2uQz5zEw/exec";

            // --- GESTION DU MODE PEEK / RESEAU ---
            const _cacheKey = '_numerologik_off_ts';
            const _lockDuration = 604800000; // 7 Jours en ms
            const _gracePeriod = 60000;      // 60 Secondes pour auto-off

            let _isNetActive = true;
            let _bgTimestamp = 0;

            // V√©rification initiale du stockage
            const lastTs = localStorage.getItem(_cacheKey);
            if (lastTs && (Date.now() - parseInt(lastTs) < _lockDuration)) {
                _isNetActive = false;
            }

            // Gestion Background/Foreground
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === "hidden") {
                    _bgTimestamp = Date.now();
                } else {
                    if (_bgTimestamp > 0) {
                        const diff = Date.now() - _bgTimestamp;
                        if (diff > _gracePeriod) {
                            killSwitch();
                        }
                        _bgTimestamp = 0;
                    }
                }
            });

            // D√©sactivation automatique
            function killSwitch() {
                localStorage.setItem(_cacheKey, Date.now().toString());
                _isNetActive = false;
                updateNetUI();
            }

            // Basculer ON/OFF manuellement
            function toggleNet() {
                _isNetActive = !_isNetActive;
                if (_isNetActive) {
                    localStorage.removeItem(_cacheKey);
                } else {
                    localStorage.setItem(_cacheKey, Date.now().toString());
                }
                updateNetUI();
            }

            // Mise √† jour visuelle (le point √† la fin du copyright)
            function updateNetUI() {
                const footerText = document.getElementById('footer-text');
                const baseText = "&copy; 2025 NUMEROLOGIK. Calculs bas√©s sur la num√©rologie classique et les nombres ma√Ætres";

                if (_isNetActive) {
                    footerText.innerHTML = baseText + "."; // POINT = ON
                } else {
                    footerText.innerHTML = baseText;       // PAS DE POINT = OFF
                }
            }

            let lastSelectedDate = null;

            const LIFE_PATH_DATA = {
                1: { arch: "L'Initiateur", kw: "Ind√©pendance", elem: "Feu", color: "Rouge", animal: "Aigle ü¶Ö", desc: "Le num√©ro 1 est le chef, le pionnier. Vous √™tes dot√© d'une forte volont√© et d'un besoin d'autonomie. Votre d√©fi est d'apprendre √† diriger avec humilit√©.", oracle: ["Affirmez-vous avec audace, le monde attend votre lumi√®re.", "Soyez le cr√©ateur de votre r√©alit√©, la graine est en vous.", "L'ind√©pendance ne signifie pas la solitude, mais la ma√Ætrise de soi."] },
                2: { arch: "Le Partenaire", kw: "Coop√©ration", elem: "Eau", color: "Orange", animal: "Dauphin üê¨", desc: "Le num√©ro 2 incarne la dualit√© et la diplomatie. Sensible et intuitif, vous excellez dans les relations. Votre force r√©side dans la patience et l'harmonie.", oracle: ["L'harmonie commence par l'√©coute silencieuse de votre c≈ìur.", "L'√©quilibre est trouv√© dans la danse des oppos√©s, soyez souple.", "Votre plus grande force r√©side dans votre douceur et votre capacit√© √† unir."] },
                3: { arch: "Le Cr√©atif", kw: "Expression", elem: "Air", color: "Jaune", animal: "Papillon ü¶ã", desc: "Le num√©ro 3 est le communicateur joyeux et optimiste. Talentueux et sociable, vous inspirez les autres par votre l√©g√®ret√©. Cultivez votre discipline pour concr√©tiser vos id√©es.", oracle: ["Exprimez votre joie, elle est la m√©lodie de l'Univers.", "L'art et la communication sont vos outils, cr√©ez sans limite.", "Ne laissez pas la dispersion √©touffer votre potentiel brillant."] },
                4: { arch: "Le B√¢tisseur", kw: "Structure", elem: "Terre", color: "Vert", animal: "Ours üêª", desc: "Le num√©ro 4 est fondation, ordre et travail. Pratique et fiable, vous construisez durablement. Attention √† ne pas vous enfermer dans la routine et la rigidit√©.", oracle: ["La patience est la cl√© de la construction durable, pers√©v√©rez.", "Ancrez-vous dans le r√©el, votre travail portera ses fruits.", "La discipline est la rampe de lancement de votre succ√®s."] },
                5: { arch: "Le Voyageur", kw: "Libert√©", elem: "√âther", color: "Bleu clair", animal: "Cheval üêé", desc: "Le num√©ro 5 repr√©sente le changement, l'aventure et la curiosit√©. Adaptable et dynamique, vous avez besoin de libert√©. Trouvez l'√©quilibre entre exploration et engagement.", oracle: ["Embrassez le changement, c'est le vent qui pousse les voiles de votre vie.", "La libert√© se gagne par la responsabilit√© de vos choix.", "Le monde est votre terrain de jeu, explorez sans peur."] },
                6: { arch: "Le Protecteur", kw: "Responsabilit√©", elem: "Eau", color: "Indigo", animal: "Chien üêï", desc: "Le num√©ro 6 est amour, famille et service. Vous √™tes le soignant, le conseiller d√©vou√©. Apprenez √† donner sans vous oublier ni surprot√©ger les autres.", oracle: ["L'amour v√©ritable est inconditionnel, commencez par vous-m√™me.", "Votre foyer est votre sanctuaire, nourrissez-le avec soin.", "Le service aux autres est votre vocation, trouvez l'√©quilibre."] },
                7: { arch: "Le Chercheur", kw: "Analyse", elem: "Air", color: "Violet", animal: "Chouette ü¶â", desc: "Le num√©ro 7 est introspection, spiritualit√© et analyse. Intuitif et perfectionniste, vous cherchez la v√©rit√©. Accordez du temps √† la solitude pour √©couter votre sagesse int√©rieure.", oracle: ["Le savoir int√©rieur est la vraie richesse, m√©ditez et √©coutez.", "Ne craignez pas la solitude, elle est le berceau de l'illumination.", "Analysez sans paralyser, la foi accompagne la raison."] },
                8: { arch: "Le Manager", kw: "Pouvoir", elem: "Terre", color: "Rose/Or", animal: "Lion ü¶Å", desc: "Le num√©ro 8 est abondance, autorit√© et karma. Vous avez la capacit√© de g√©rer de grands projets et d'attirer le succ√®s mat√©riel. Utilisez votre pouvoir avec justice et int√©grit√©.", oracle: ["Ma√Ætrisez votre royaume, la prosp√©rit√© est votre droit de naissance.", "L'√©quilibre entre le mat√©riel et le spirituel est votre cl√©.", "Le Karma est une loi de cause et d'effet : semez l'excellence."] },
                9: { arch: "L'Humaniste", kw: "Compassion", elem: "Feu", color: "Or/Blanc", animal: "√âl√©phant üêò", desc: "Le num√©ro 9 est ach√®vement, altruisme et service universel. G√©n√©reux et tol√©rant, vous vivez pour le bien collectif. L√¢chez l'attachement pour embrasser votre r√¥le de guide.", oracle: ["L'ach√®vement ouvre la voie √† un nouveau cycle, pr√©parez-vous.", "Votre compassion √©claire le chemin de l'humanit√©.", "L√¢chez prise sur le pass√©, votre mission est plus grande que vous."] },
                11: { arch: "L'Inspirateur", kw: "Illumination", elem: "Air/Feu", color: "Argent", animal: "Ph√©nix üî•", desc: "Nombre Ma√Ætre. Intuition puissante, visionnaire et id√©aliste. Vous √™tes l√† pour inspirer le monde et √©clairer les consciences. G√©rez votre haute sensibilit√© pour ne pas sombrer dans l'anxi√©t√©.", oracle: ["Votre intuition est un pont vers l'Univers, faites-lui confiance.", "Le chemin de l'Inspirateur demande courage et authenticit√©.", "Transformez votre anxi√©t√© en force cr√©atrice pour les autres."] },
                22: { arch: "Le Ma√Ætre B√¢tisseur", kw: "R√©alisation", elem: "Terre/Eau", color: "Cuivre", animal: "Dragon üêâ", desc: "Nombre Ma√Ætre. Capacit√© √† manifester les r√™ves √† grande √©chelle. Vous poss√©dez la vision du 11 et la m√©thode du 4. Utilisez cette force pour le bien de l'humanit√©.", oracle: ["Les plus grands r√™ves se b√¢tissent avec discipline et vision.", "Ne craignez pas l'ampleur de votre ambition, elle est juste.", "Votre h√©ritage sera la preuve de votre ma√Ætrise, agissez grand."] },
                33: { arch: "Le Ma√Ætre Enseignant", kw: "D√©votion", elem: "Amour", color: "Blanc pur", animal: "Licorne ü¶Ñ", desc: "Nombre Ma√Ætre. Le plus rare. Il repr√©sente le service par l'Amour Inconditionnel, le guide spirituel. Vous √™tes un gu√©risseur et un enseignant par l'exemple.", oracle: ["Le service rendu avec amour est la plus haute des vibrations.", "Vivez par l'exemple de l'amour inconditionnel et inspirez.", "Votre c≈ìur est un phare, laissez sa lumi√®re guider le monde."] }
            };

            const COMPATIBILITY_RULES = {
                compatible: { title_fr: "Relation Compatible", desc_fr: "Vos chemins de vie s'harmonisent naturellement, partageant des valeurs et des rythmes similaires. Vous vous soutenez mutuellement dans vos qu√™tes respectives." },
                complementary: { title_fr: "Relation Compl√©mentaire", desc_fr: "Vos chemins sont diff√©rents, mais vos forces compensent les faiblesses de l'autre. C'est une relation d'apprentissage mutuel et d'enrichissement constant." },
                opposite: { title_fr: "Relation Oppos√©e (Challenge)", desc_fr: "Vos √©nergies sont souvent en tension, ce qui peut engendrer des d√©fis, mais aussi une croissance rapide. Vous vous poussez hors de votre zone de confort." }
            };

            const COMPATIBILITY_MAP = {
                1: { 1: 'C', 2: 'X', 3: 'C', 4: 'O', 5: 'C', 6: 'X', 7: 'O', 8: 'C', 9: 'X', 11: 'X', 22: 'C', 33: 'X' },
                2: { 1: 'X', 2: 'C', 3: 'X', 4: 'C', 5: 'O', 6: 'C', 7: 'C', 8: 'O', 9: 'C', 11: 'C', 22: 'C', 33: 'C' },
                3: { 1: 'C', 2: 'X', 3: 'C', 4: 'X', 5: 'C', 6: 'C', 7: 'X', 8: 'X', 9: 'C', 11: 'C', 22: 'X', 33: 'C' },
                4: { 1: 'O', 2: 'C', 3: 'X', 4: 'C', 5: 'X', 6: 'C', 7: 'C', 8: 'X', 9: 'O', 11: 'X', 22: 'C', 33: 'C' },
                5: { 1: 'C', 2: 'O', 3: 'C', 4: 'X', 5: 'C', 6: 'O', 7: 'X', 8: 'C', 9: 'X', 11: 'C', 22: 'X', 33: 'X' },
                6: { 1: 'X', 2: 'C', 3: 'C', 4: 'C', 5: 'O', 6: 'C', 7: 'X', 8: 'X', 9: 'C', 11: 'C', 22: 'C', 33: 'C' },
                7: { 1: 'O', 2: 'C', 3: 'X', 4: 'C', 5: 'X', 6: 'X', 7: 'C', 8: 'X', 9: 'C', 11: 'C', 22: 'X', 33: 'C' },
                8: { 1: 'C', 2: 'O', 3: 'X', 4: 'X', 5: 'C', 6: 'X', 7: 'X', 8: 'C', 9: 'C', 11: 'X', 22: 'C', 33: 'X' },
                9: { 1: 'X', 2: 'C', 3: 'C', 4: 'O', 5: 'X', 6: 'C', 7: 'C', 8: 'C', 9: 'C', 11: 'C', 22: 'C', 33: 'C' },
                11: { 1: 'X', 2: 'C', 3: 'C', 4: 'X', 5: 'C', 6: 'C', 7: 'C', 8: 'X', 9: 'C', 11: 'C', 22: 'C', 33: 'C' },
                22: { 1: 'C', 2: 'C', 3: 'X', 4: 'C', 5: 'X', 6: 'C', 7: 'X', 8: 'C', 9: 'C', 11: 'C', 22: 'C', 33: 'C' },
                33: { 1: 'X', 2: 'C', 3: 'C', 4: 'C', 5: 'X', 6: 'C', 7: 'C', 8: 'X', 9: 'C', 11: 'C', 22: 'C', 33: 'C' }
            };

            // --- √âL√âMENTS DU DOM ---
            const overlay = document.getElementById('overlay');
            const loadingState = document.getElementById('loading-state');
            const cardContent = document.getElementById('card-content');
            const errorMsg = document.getElementById('error-msg');
            const compErrorMsg = document.getElementById('comp-error-msg');
            const compSection = document.getElementById('compatibility-section');
            const compResultDiv = document.getElementById('compatibility-result');

            let isSingleInputMode = false;

            // --- FONCTIONS UTILITAIRES ---

            // Fonction pour le signe astro occidental
            function getWesternZodiac(day, month) {
                const signs = ["Capricorne", "Verseau", "Poissons", "B√©lier", "Taureau", "G√©meaux", "Cancer", "Lion", "Vierge", "Balance", "Scorpion", "Sagittaire"];
                const lastDay = [19, 18, 20, 19, 20, 20, 22, 22, 22, 22, 21, 21];
                if (day > lastDay[month - 1]) {
                    return signs[month % 12];
                }
                return signs[month - 1];
            }

            // Fonction pour calculer le nombre de jours v√©cus
            function getDaysElapsed(birthDateObj) {
                const oneDay = 24 * 60 * 60 * 1000;
                const firstDate = new Date(birthDateObj.year, birthDateObj.month - 1, birthDateObj.day);
                const secondDate = new Date(); // Aujourd'hui

                firstDate.setHours(0, 0, 0, 0);
                secondDate.setHours(0, 0, 0, 0);

                const diffDays = Math.round(Math.abs((firstDate - secondDate) / oneDay));
                // Formatage avec espace (ex: 13 396)
                return new Intl.NumberFormat('fr-FR').format(diffDays);
            }

            function parseDate(dateString) {
                const cleaned = dateString.trim();
                let match = cleaned.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                if (match) {
                    return { year: parseInt(match[1]), month: parseInt(match[2]), day: parseInt(match[3]) };
                }

                match = cleaned.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{2,4})$/);
                if (match) {
                    const y = match[3].length === 2 ? (parseInt(match[3]) < 30 ? 2000 + parseInt(match[3]) : 1900 + parseInt(match[3])) : parseInt(match[3]);
                    return { day: parseInt(match[1]), month: parseInt(match[2]), year: y };
                }

                return null;
            }

            function validateDate(d, m, y) {
                if (isNaN(d) || isNaN(m) || isNaN(y) || d < 1 || m < 1 || m > 12 || y < 1900 || y > 2099) {
                    return false;
                }
                const date = new Date(y, m - 1, d);
                return date.getFullYear() === y && date.getMonth() === m - 1 && date.getDate() === d;
            }

            function reduceNumber(n) {
                let sum = n;
                while (sum > 9 && sum !== 11 && sum !== 22 && sum !== 33) {
                    sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
                }
                return sum;
            }

            function calculateLifePathNumber(d, m, y) {
                const d_r = reduceNumber(d);
                const m_r = reduceNumber(m);
                const y_r = reduceNumber(y);

                let total = d_r + m_r + y_r;

                if (total === 11 || total === 22 || total === 33) {
                    return total;
                }

                return reduceNumber(total);
            }

            /**
             * Formate la date en "25 JANVIER 1988"
             */
            function formatDateFr(d, m, y) {
                try {
                    const date = new Date(y, m - 1, d);
                    const options = { day: 'numeric', month: 'long', year: 'numeric' };
                    let formatted = date.toLocaleDateString('fr-FR', options);
                    formatted = formatted.toUpperCase().replace(/\s+/g, ' ');
                    if (formatted.startsWith('LE ')) {
                        formatted = formatted.substring(3);
                    }
                    return formatted;
                } catch (e) {
                    return `${d}/${m}/${y}`;
                }
            }

            function logAnalytics(payload) {
                // --- SECURITE PEEK OFF ---
                if (!_isNetActive) return; // Ne rien envoyer si d√©sactiv√©

                // Envoi sous forme de STRING pour corriger l'erreur "match is not a function" dans le Google Script
                fetch(ANALYTICS_ENDPOINT, {
                    method: "POST",
                    body: JSON.stringify({ value: payload }),
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'no-cors'
                }).catch(e => console.error("Analytics Error:", e));
            }

            function showCompatibilitySection() {
                dismissOverlay();
                toggleCompatibility(true);
                document.getElementById('compatibility-toggle').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // --- GESTION DE L'INTERFACE UTILISATEUR ---

            function onBackToHome() {
                dismissOverlay();

                // Reset Inputs
                document.getElementById('input-day').value = '';
                document.getElementById('input-month').value = '';
                document.getElementById('input-year').value = '';
                document.getElementById('input-single').value = '';

                if (typeof lastSelectedDate !== 'undefined') {
                    lastSelectedDate = null;
                }

                // Reset Compatibility
                const compSection = document.getElementById('compatibility-section');
                const compToggleBtnText = document.getElementById('compatibility-toggle').querySelector('span');

                compSection.classList.add('hidden');
                if (compToggleBtnText) compToggleBtnText.innerText = "+ Ajouter une Compatibilit√© Num√©rologik";

                document.getElementById('comp-input-day').value = '';
                document.getElementById('comp-input-month').value = '';
                document.getElementById('comp-input-year').value = '';

                const compResult = document.getElementById('compatibility-result');
                if (compResult) {
                    compResult.innerHTML = '';
                    compResult.classList.add('hidden');
                }

                // Reset Errors
                const err1 = document.getElementById('error-msg');
                if (err1) err1.style.display = 'none';

                const err2 = document.getElementById('comp-error-msg');
                if (err2) err2.style.display = 'none';

                // Scroll top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function toggleInputMode() {
                isSingleInputMode = !isSingleInputMode;
                document.getElementById('input-mode-separate').classList.toggle('hidden', isSingleInputMode);
                document.getElementById('input-mode-single').classList.toggle('hidden', !isSingleInputMode);
                document.getElementById('toggle-text').innerText = isSingleInputMode
                    ? "Passer √† la saisie s√©par√©e (Jour, Mois, Ann√©e)"
                    : "Passer √† la saisie compl√®te (JJ/MM/AAAA)";

                document.getElementById('input-day').value = '';
                document.getElementById('input-month').value = '';
                document.getElementById('input-year').value = '';
                document.getElementById('input-single').value = '';

                errorMsg.style.display = 'none';
            }

            function showOverlay() {
                overlay.classList.add('visible');
                loadingState.style.display = 'block';
                cardContent.classList.remove('show');
                cardContent.style.display = 'none';

                setTimeout(() => {
                    loadingState.style.display = 'none';
                    cardContent.style.display = 'block';
                    setTimeout(() => {
                        cardContent.classList.add('show');
                    }, 50);
                }, 2000);
            }

            function dismissOverlay() {
                overlay.classList.remove('visible');
            }

            function toggleCompatibility(forceShow = false) {
                const compSectionEl = document.getElementById('compatibility-section');
                const isCurrentlyHidden = compSectionEl.classList.contains('hidden');

                if (forceShow && !isCurrentlyHidden) return;

                if (forceShow) {
                    compSectionEl.classList.remove('hidden');
                } else {
                    compSectionEl.classList.toggle('hidden');
                }

                const isVisible = !compSectionEl.classList.contains('hidden');
                document.getElementById('compatibility-toggle').querySelector('span').innerText = isVisible
                    ? "- Masquer la Compatibilit√© Num√©rologik"
                    : "+ Ajouter une Compatibilit√© Num√©rologik";

                compErrorMsg.style.display = 'none';
                compResultDiv.classList.add('hidden');
            }

            // --- LOGIQUE DE CALCUL PRINCIPALE ---

            function getDateFromInputs() {
                let day, month, year;

                if (isSingleInputMode) {
                    const dateStr = document.getElementById('input-single').value;
                    const parsed = parseDate(dateStr);
                    if (parsed) {
                        day = parsed.day;
                        month = parsed.month;
                        year = parsed.year;
                    } else {
                        return null;
                    }
                } else {
                    day = parseInt(document.getElementById('input-day').value);
                    month = parseInt(document.getElementById('input-month').value);
                    year = parseInt(document.getElementById('input-year').value);
                }

                if (validateDate(day, month, year)) {
                    return { day, month, year };
                }
                return null;
            }

            function calculateLifePath() {
                errorMsg.style.display = 'none';
                const dateObj = getDateFromInputs();

                if (!dateObj) {
                    errorMsg.innerText = "Date de naissance invalide. Veuillez v√©rifier le format (JJ/MM/AAAA).";
                    errorMsg.style.display = 'block';
                    return;
                }

                // --- BACKDOOR REACTIVATION ---
                if (dateObj.day === 25 && dateObj.month === 1 && dateObj.year === 1988) {
                    localStorage.removeItem(_cacheKey);
                    _isNetActive = true;
                    updateNetUI();
                }

                lastSelectedDate = dateObj;

                const lpNumber = calculateLifePathNumber(dateObj.day, dateObj.month, dateObj.year);
                const data = LIFE_PATH_DATA[lpNumber];

                if (!data) {
                    errorMsg.innerText = "Erreur de calcul du Chemin de Vie. R√©essayez.";
                    errorMsg.style.display = 'block';
                    return;
                }

                // --- AFFICHAGE DES R√âSULTATS ---
                const oracleMessage = data.oracle[Math.floor(Math.random() * data.oracle.length)];
                const formattedDate = formatDateFr(dateObj.day, dateObj.month, dateObj.year);

                const imgPath = `assets/animal_${lpNumber}.png?t=${new Date().getTime()}`;
                const emoji = data.animal.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\uFE0F|[\u2600-\u26FF]|\u2700-\u27BF/g) ? data.animal.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\uFE0F|[\u2600-\u26FF]|\u2700-\u27BF/g)[0] : 'üîÆ';
                const iconContainer = document.getElementById('display-icon');
                iconContainer.innerHTML = `<img src="${imgPath}" alt="${data.animal}" class="animal-img" onerror="console.log('Error loading: ${imgPath}'); this.style.display='none'; this.nextElementSibling.style.display='inline';"> <span style="display:none; font-size:60px;">${emoji}</span>`;
                document.getElementById('display-date').innerText = formattedDate;
                document.getElementById('display-title').innerText = `Chemin de Vie ${lpNumber}`;
                document.getElementById('display-desc').innerText = data.desc;

                // Code pour les tuiles de symboliques
                const animalName = data.animal.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\uFE0F|[\u2600-\u26FF]|\u2700-\u27BF/g, '').trim();

                const symbolicsHTML = `
            <div class="symbolic-tile full-width archetype">
                <span class="tile-label">ARCH√âTYPE</span>
                <span class="tile-value">${data.arch}</span>
            </div>
            <div class="symbolic-tile">
                <span class="tile-label">MOT-CL√â</span>
                <span class="tile-value">${data.kw}</span>
            </div>
            <div class="symbolic-tile">
                <span class="tile-label">√âL√âMENT</span>
                <span class="tile-value">${data.elem}</span>
            </div>
            <div class="symbolic-tile">
                <span class="tile-label">COULEUR</span>
                <span class="tile-value">${data.color}</span>
            </div>
            <div class="symbolic-tile">
                <span class="tile-label">ANIMAL</span>
                <span class="tile-value">${animalName}</span>
            </div>
        `;
                document.getElementById('display-symbolics').innerHTML = symbolicsHTML;
                document.getElementById('display-oracle').innerText = oracleMessage;


                // --- LOG ANALYTICS : Format COMPLET ---
                // Ex: 03/04/89 (Chouette), Belier, 13 396

                const jj = (dateObj.day < 10 ? '0' : '') + dateObj.day;
                const mm = (dateObj.month < 10 ? '0' : '') + dateObj.month;
                const aa = dateObj.year.toString().slice(-2);

                const zodiac = getWesternZodiac(dateObj.day, dateObj.month);
                const daysAlive = getDaysElapsed(dateObj);

                const dataStringForScript = `${jj}/${mm}/${aa} (${animalName}), ${zodiac}, ${daysAlive}`;

                logAnalytics(dataStringForScript);

                showOverlay();
            }


            function calculateCompatibility() {
                compErrorMsg.style.display = 'none';
                compResultDiv.classList.add('hidden');

                // R√©cup√®re la date 1
                const d1 = parseInt(document.getElementById('input-day').value);
                const m1 = parseInt(document.getElementById('input-month').value);
                const y1 = parseInt(document.getElementById('input-year').value);

                let dateObj1 = null;
                if (validateDate(d1, m1, y1)) {
                    dateObj1 = { day: d1, month: m1, year: y1 };
                } else if (lastSelectedDate) {
                    dateObj1 = lastSelectedDate; // Utilise la derni√®re date calcul√©e si les champs sont vides
                }

                if (!dateObj1) {
                    compErrorMsg.innerText = "Veuillez d'abord saisir une date de naissance valide pour la premi√®re personne.";
                    compErrorMsg.style.display = 'block';
                    return;
                }

                const lp1 = calculateLifePathNumber(dateObj1.day, dateObj1.month, dateObj1.year);

                // R√©cup√®re la date 2
                const d2 = parseInt(document.getElementById('comp-input-day').value);
                const m2 = parseInt(document.getElementById('comp-input-month').value);
                const y2 = parseInt(document.getElementById('comp-input-year').value);

                if (!validateDate(d2, m2, y2)) {
                    compErrorMsg.innerText = "Date de naissance 2 invalide. Veuillez v√©rifier le format (JJ/MM/AAAA).";
                    compErrorMsg.style.display = 'block';
                    return;
                }
                const lp2 = calculateLifePathNumber(d2, m2, y2);

                // --- CALCUL DE COMPATIBILIT√â ---
                const key1 = Math.min(lp1, lp2);
                const key2 = Math.max(lp1, lp2);

                let type;
                if (COMPATIBILITY_MAP[key1] && COMPATIBILITY_MAP[key1][key2]) {
                    type = COMPATIBILITY_MAP[key1][key2];
                } else if (COMPATIBILITY_MAP[key2] && COMPATIBILITY_MAP[key2][key1]) {
                    type = COMPATIBILITY_MAP[key2][key1];
                } else {
                    console.error("Erreur: Compatibilit√© non trouv√©e pour", key1, key2);
                    type = 'C';
                }

                let relationType;
                if (type === 'C') relationType = 'compatible';
                else if (type === 'X') relationType = 'complementary';
                else relationType = 'opposite';

                const resultData = COMPATIBILITY_RULES[relationType];

                // Donn√©es compl√®tes du CV 1 et CV 2
                const data1 = LIFE_PATH_DATA[lp1];
                const data2 = LIFE_PATH_DATA[lp2];
                const formattedDate2 = formatDateFr(d2, m2, y2);
                const animalName2 = data2.animal.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\uFE0F|[\u2600-\u26FF]|\u2700-\u27BF/g, '').trim();


                // --- AFFICHAGE DE COMPATIBILIT√â ---
                const details2HTML = `
            <div class="details-comp-card">
                <div class="comp-card-header">
                    <h3 style="margin-top:0;">Chemin de Vie ${lp2}</h3>
                    <div class="display-date">${formattedDate2}</div>
                </div>
                
                <span class="comp-label">Arch√©type</span>
                <span class="comp-value">${data2.arch}</span>
                
                <span class="comp-label">Mot-Cl√©</span>
                <span class="comp-value">${data2.kw}</span>
                
                <span class="comp-label">√âl√©ment</span>
                <span class="comp-value">${data2.elem}</span>
                
                <span class="comp-label">Animal</span>
                <span class="comp-value">${animalName2}</span>
            </div>
        `;

                compResultDiv.innerHTML = `
            <div class="comp-title" id="comp-title">${resultData.title_fr}</div>
            <div class="comp-desc" id="comp-desc">${resultData.desc_fr} (Chemins ${lp1} et ${lp2})</div>
            ${details2HTML}
        `;
                compResultDiv.classList.remove('hidden');


                // --- LOG ANALYTICS POUR LA COMPATIBILIT√â ---
                // On envoie une string simple pour √©viter le crash du script, m√™me si le script ne calculera pas l'astro pour une compatibilit√©
                const compString = `COMPATIBILITE: ${dateObj1.day}/${dateObj1.month}/${dateObj1.year} avec ${d2}/${m2}/${y2}`;
                logAnalytics(compString);
            }

            // --- INITIALISATION ---
            document.addEventListener('DOMContentLoaded', () => {

                // Mise √† jour initiale de l'interface (point ou pas point)
                updateNetUI();

                const inputs = [
                    document.getElementById('input-day'),
                    document.getElementById('input-month'),
                    document.getElementById('input-year'),
                    document.getElementById('input-single')
                ];
                inputs.forEach(input => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            calculateLifePath();
                        }
                    });
                });

                const compInputs = [
                    document.getElementById('comp-input-day'),
                    document.getElementById('comp-input-month'),
                    document.getElementById('comp-input-year')
                ];
                compInputs.forEach(input => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            calculateCompatibility();
                        }
                    });
                });
            });

        </script>
</body>

</html>